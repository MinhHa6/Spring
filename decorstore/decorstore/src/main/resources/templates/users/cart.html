<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="users/fragments/head :: head"></head>
<body class="goto-here">

<div>
    <nav th:replace="users/fragments/navbar :: nav"></nav>
</div>

<section class="ftco-section ftco-cart">
    <div class="container">
        <div class="row">
            <div class="col-md-12 ftco-animate fadeInUp ftco-animated">
                <div class="cart-list">
                    <table class="table">
                        <thead class="thead-primary">
                        <tr class="text-center">
                            <th>
                                <input type="checkbox" id="selectAll" onclick="toggleSelectAll()">
                            </th>
                            <th>&nbsp;</th>
                            <th>Hình ảnh</th>
                            <th>Tên sản phẩm</th>
                            <th>Giá</th>
                            <th>Số lượng</th>
                            <th>Tổng</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="item : ${cartItems}" class="text-center">
                            <td>
                                <input type="checkbox"
                                       class="item-checkbox"
                                       th:data-product-id="${item.product.id}"
                                       th:data-price="${item.total}"
                                       onclick="calculateSelectedTotal()">
                            </td>

                            <td class="product-remove">
                                <a th:href="@{/cart/remove/{id}(id=${item.product.id})}">
                                    <span class="ion-ios-close"></span>
                                </a>
                            </td>

                            <td class="image-prod">
                                <img th:src="@{'/uploads/' + ${item.product.mainImage}}"
                                     class="img"
                                     style="width: 100px; height: 100px;">
                            </td>

                            <td class="product-name">
                                <h3 th:text="${item.product.name}"></h3>
                            </td>

                            <td class="price" th:text="${#numbers.formatDecimal(item.product.price, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>

                            <td class="quantity">
                                <form th:action="@{/cart/update}" method="post">
                                    <input type="hidden" name="id" th:value="${item.product.id}">
                                    <input type="number"
                                           name="quantity"
                                           th:value="${item.quantity}"
                                           min="1"
                                           class="form-control text-center"
                                           style="width: 80px; display: inline-block;"
                                           onchange="this.form.submit()">
                                </form>
                            </td>

                            <td class="total" th:text="${#numbers.formatDecimal(item.total, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tổng tiền -->
        <div class="row justify-content-end">
            <div class="col col-lg-5 col-md-6 mt-5 cart-wrap ftco-animate">
                <div class="cart-total mb-3">
                    <h3>Tổng giỏ hàng</h3>
                    <p class="d-flex">
                        <span>Tổng tất cả sản phẩm</span>
                        <span th:text="${#numbers.formatDecimal(subTotal, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></span>
                    </p>
                    <p class="d-flex">
                        <span>Tổng sản phẩm đã chọn</span>
                        <span id="selectedSubTotal">0 ₫</span>
                    </p>
                    <p class="d-flex">
                        <span>Phí vận chuyển</span>
                        <span id="shippingFee" th:text="${#numbers.formatDecimal(shipping, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></span>
                    </p>
                    <hr>
                    <p class="d-flex total-price">
                        <span>Tổng thanh toán</span>
                        <span id="finalTotal">0 ₫</span>
                    </p>
                </div>
                <p>
                    <button onclick="proceedToCheckout()" class="btn btn-primary py-3 px-4">
                        Thanh toán (<span id="selectedCount">0</span> sản phẩm)
                    </button>
                </p>
            </div>
        </div>
    </div>
</section>
<div th:replace="users/fragments/script :: script"></div>

<footer th:replace="users/fragments/footer :: footer"></footer>

<script th:inline="javascript">
    /*<![CDATA[*/
    // Lấy giá trị từ server
    const shippingFee = /*[[${shipping}]]*/ 30000;

    console.log('Shipping fee:', shippingFee); // Debug

    // Chọn tất cả checkbox
    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.item-checkbox');

        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });

        calculateSelectedTotal();
    }

    // Tính tổng tiền các sản phẩm đã chọn
    function calculateSelectedTotal() {
        console.log("=== Calculating Total ===");

        const checkboxes = document.querySelectorAll('.item-checkbox:checked');
        let selectedTotal = 0;
        let selectedCount = 0;

        checkboxes.forEach(checkbox => {
            // Lấy giá trị trực tiếp (đã là số từ Thymeleaf)
            const price = parseFloat(checkbox.dataset.price);
            console.log('Product ID:', checkbox.dataset.productId, 'Price:', price);

            if (!isNaN(price)) {
                selectedTotal += price;
                selectedCount++;
            }
        });

        console.log('Selected Total:', selectedTotal);
        console.log('Selected Count:', selectedCount);

        // Cập nhật UI
        document.getElementById('selectedSubTotal').textContent = formatMoney(selectedTotal);
        document.getElementById('selectedCount').textContent = selectedCount;

        // Tính tổng cuối (có phí ship nếu chọn ít nhất 1 sản phẩm)
        const finalTotal = selectedCount > 0 ? selectedTotal + shippingFee : 0;
        document.getElementById('finalTotal').textContent = formatMoney(finalTotal);

        // Cập nhật trạng thái "Chọn tất cả"
        const allCheckboxes = document.querySelectorAll('.item-checkbox');
        const selectAllCheckbox = document.getElementById('selectAll');
        selectAllCheckbox.checked = (checkboxes.length === allCheckboxes.length && allCheckboxes.length > 0);
    }

    // Format tiền VNĐ
    function formatMoney(amount) {
        return new Intl.NumberFormat('vi-VN').format(amount) + ' ₫';
    }

    // Tiến hành thanh toán
    function proceedToCheckout() {
        const checkboxes = document.querySelectorAll('.item-checkbox:checked');

        if (checkboxes.length === 0) {
            alert('Vui lòng chọn ít nhất một sản phẩm để thanh toán!');
            return;
        }

        // Lấy danh sách ID sản phẩm đã chọn
        const selectedProductIds = Array.from(checkboxes).map(cb => cb.dataset.productId);

        console.log('Selected products:', selectedProductIds);


        // Chuyển sang trang checkout với danh sách sản phẩm đã chọn
        window.location.href = '/checkout?products=' + selectedProductIds.join(',');
    }

    // Tự động tính toán khi load trang
    window.addEventListener('DOMContentLoaded', function() {
        console.log('Page loaded, calculating initial total...');
        calculateSelectedTotal();
    });
    /*]]>*/
</script>

</body>
</html>