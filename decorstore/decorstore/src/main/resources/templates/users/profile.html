<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="users/fragments/head :: head"></head>
<body class="goto-here">

<div>
    <nav th:replace="users/fragments/navbar :: nav"></nav>
</div>

<section class="ftco-section">
    <div class="container">
        <div class="row">
            <!-- Sidebar Menu -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <img th:if="${customer != null && customer.avatar != null}"
                                 th:src="@{'/uploads/' + ${customer.avatar}}"
                                 class="rounded-circle"
                                 style="width: 100px; height: 100px; object-fit: cover;"
                                 alt="Avatar">
                            <img th:if="${customer == null || customer.avatar == null}"
                                 src="https://via.placeholder.com/100"
                                 class="rounded-circle"
                                 style="width: 100px; height: 100px;"
                                 alt="Avatar">
                            <h5 class="mt-2" th:text="${user.username}">Username</h5>
                        </div>

                        <div class="list-group list-group-flush">
                            <a href="#profile"
                               class="list-group-item list-group-item-action active"
                               data-toggle="tab">
                                <i class="fas fa-user"></i> Thông tin cá nhân
                            </a>
                            <a href="#change-password"
                               class="list-group-item list-group-item-action"
                               data-toggle="tab">
                                <i class="fas fa-key"></i> Đổi mật khẩu
                            </a>
                            <a th:href="@{/order/history}"
                               class="list-group-item list-group-item-action">
                                <i class="fas fa-shopping-bag"></i> Đơn hàng của tôi
                            </a>
                            <a th:href="@{/logout}"
                               class="list-group-item list-group-item-action text-danger"
                               onclick="event.preventDefault(); document.getElementById('logout-form').submit();">
                                <i class="fas fa-sign-out-alt"></i> Đăng xuất
                            </a>
                        </div>

                        <form id="logout-form" th:action="@{/logout}" method="post" style="display: none;"></form>
                    </div>
                </div>
            </div>

            <!-- Nội dung chính -->
            <div class="col-md-9">
                <div class="tab-content">
                    <!-- Tab Thông tin cá nhân -->
                    <div class="tab-pane fade show active" id="profile">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="mb-0">Thông tin cá nhân</h4>
                            </div>
                            <div class="card-body">
                                <!-- Thông báo -->
                                <div th:if="${param.success}" class="alert alert-success alert-dismissible fade show">
                                    <i class="fas fa-check-circle"></i>
                                    Cập nhật thông tin thành công!
                                    <button type="button" class="close" data-dismiss="alert">
                                        <span>&times;</span>
                                    </button>
                                </div>

                                <div th:if="${error}" class="alert alert-danger">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <span th:text="${error}"></span>
                                </div>

                                <!-- Form cập nhật thông tin -->
                                <form th:action="@{/profile/update}" method="post" enctype="multipart/form-data">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="fullName">Họ và tên <span class="text-danger">*</span></label>
                                                <input type="text"
                                                       class="form-control"
                                                       id="fullName"
                                                       name="fullName"
                                                       th:value="${customer != null ? customer.name : ''}"
                                                       required>
                                            </div>
                                        </div>

                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="email">Email</label>
                                                <input type="email"
                                                       class="form-control"
                                                       id="email"
                                                       name="email"
                                                       th:value="${user.email}"
                                                       readonly>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="phone">Số điện thoại</label>
                                                <input type="tel"
                                                       class="form-control"
                                                       id="phone"
                                                       name="phone"
                                                       th:value="${customer != null ? customer.phone : ''}"
                                                       pattern="[0-9]{10,11}"
                                                       placeholder="0123456789">
                                            </div>
                                        </div>

                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="avatar">Ảnh đại diện</label>
                                                <input type="file"
                                                       class="form-control-file"
                                                       id="avatar"
                                                       name="avatarFile"
                                                       accept="image/*">
                                                <small class="form-text text-muted">Chọn ảnh JPG, PNG (tối đa 2MB)</small>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="address">Địa chỉ</label>
                                        <textarea class="form-control"
                                                  id="address"
                                                  name="address"
                                                  rows="3"
                                                  th:text="${customer != null ? customer.address : ''}"></textarea>
                                    </div>

                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Cập nhật thông tin
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Đổi mật khẩu -->
                    <div class="tab-pane fade" id="change-password">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="mb-0">Đổi mật khẩu</h4>
                            </div>
                            <div class="card-body">
                                <!-- Thông báo -->
                                <div th:if="${param.passwordChanged}" class="alert alert-success alert-dismissible fade show">
                                    <i class="fas fa-check-circle"></i>
                                    Đổi mật khẩu thành công!
                                    <button type="button" class="close" data-dismiss="alert">
                                        <span>&times;</span>
                                    </button>
                                </div>

                                <div th:if="${passwordError}" class="alert alert-danger">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <span th:text="${passwordError}"></span>
                                </div>

                                <!-- Form đổi mật khẩu -->
                                <form th:action="@{/profile/change-password}" method="post">
                                    <div class="form-group">
                                        <label for="currentPassword">Mật khẩu hiện tại <span class="text-danger">*</span></label>
                                        <input type="password"
                                               class="form-control"
                                               id="currentPassword"
                                               name="currentPassword"
                                               required>
                                    </div>

                                    <div class="form-group">
                                        <label for="newPassword">Mật khẩu mới <span class="text-danger">*</span></label>
                                        <input type="password"
                                               class="form-control"
                                               id="newPassword"
                                               name="newPassword"
                                               minlength="6"
                                               required>
                                        <small class="form-text text-muted">Mật khẩu phải có ít nhất 6 ký tự</small>
                                    </div>

                                    <div class="form-group">
                                        <label for="confirmPassword">Xác nhận mật khẩu mới <span class="text-danger">*</span></label>
                                        <input type="password"
                                               class="form-control"
                                               id="confirmPassword"
                                               name="confirmPassword"
                                               required>
                                    </div>

                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-key"></i> Đổi mật khẩu
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<footer th:replace="users/fragments/footer :: footer"></footer>

<script>
    // Validate password confirmation
    document.querySelector('form[action*="change-password"]').addEventListener('submit', function(e) {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword !== confirmPassword) {
            e.preventDefault();
            alert('Mật khẩu xác nhận không khớp!');
        }
    });
</script>

</body>
</html>