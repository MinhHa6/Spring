<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="users/fragments/head :: head"></head>
<body class="goto-here">

<div>
    <nav th:replace="users/fragments/navbar :: nav"></nav>
</div>

<section class="ftco-section">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <h2 class="mb-4">Lịch sử đơn hàng</h2>

                <!-- Thông báo -->
                <div th:if="${param.success}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle"></i>
                    Đơn hàng đã được hủy thành công!
                    <button type="button" class="close" data-dismiss="alert">
                        <span>&times;</span>
                    </button>
                </div>

                <div th:if="${param.error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-circle"></i>
                    Có lỗi xảy ra! Vui lòng thử lại.
                    <button type="button" class="close" data-dismiss="alert">
                        <span>&times;</span>
                    </button>
                </div>

                <!-- Danh sách đơn hàng -->
                <div th:if="${orders != null && !orders.isEmpty()}">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="thead-primary">
                            <tr>
                                <th>Mã đơn hàng</th>
                                <th>Ngày đặt</th>
                                <th>Người nhận</th>
                                <th>Tổng tiền</th>
                                <th>Trạng thái</th>
                                <th>Thao tác</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="order : ${orders}">
                                <td>
                                    <strong th:text="${order.orderCode}">ORD-12345</strong>
                                </td>
                                <td th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm')}">
                                    01/01/2024 10:00
                                </td>
                                <td th:text="${order.receiverName}">Nguyễn Văn A</td>
                                <td>
                                    <strong class="text-primary"
                                            th:text="${#numbers.formatDecimal(order.totalMoney, 0, 'COMMA', 0, 'POINT')} + ' ₫'">
                                        1,000,000 ₫
                                    </strong>
                                </td>
                                <td>
                                        <span th:if="${order.active}" class="badge badge-success">
                                            <i class="fas fa-check-circle"></i> Đang xử lý
                                        </span>
                                    <span th:unless="${order.active}" class="badge badge-secondary">
                                            <i class="fas fa-times-circle"></i> Đã hủy
                                        </span>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a th:href="@{/order/detail/{id}(id=${order.id})}"
                                           class="btn btn-sm btn-info"
                                           title="Xem chi tiết">
                                            <i class="fas fa-eye"></i> Chi tiết
                                        </a>

                                        <!-- Nút hủy đơn (chỉ hiện nếu đơn còn active) -->
                                        <button th:if="${order.active}"
                                                type="button"
                                                class="btn btn-sm btn-danger"
                                                onclick="confirmCancel(/*[[${order.id}]]*/, /*[[${order.orderCode}]]*/)"
                                                title="Hủy đơn hàng">
                                            <i class="fas fa-ban"></i> Hủy
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Không có đơn hàng -->
                <div th:if="${orders == null || orders.isEmpty()}"
                     class="text-center py-5">
                    <i class="fas fa-shopping-bag fa-5x text-muted mb-3"></i>
                    <h4 class="text-muted">Bạn chưa có đơn hàng nào</h4>
                    <p class="text-muted">Hãy mua sắm ngay để trải nghiệm dịch vụ của chúng tôi!</p>
                    <a th:href="@{/shop}" class="btn btn-primary">
                        <i class="fas fa-shopping-cart"></i> Tiếp tục mua sắm
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>

<footer th:replace="users/fragments/footer :: footer"></footer>

<!-- Modal xác nhận hủy đơn -->
<div class="modal fade" id="cancelModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Xác nhận hủy đơn hàng</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn hủy đơn hàng <strong id="orderCodeText"></strong> không?</p>
                <p class="text-danger"><small>Lưu ý: Hành động này không thể hoàn tác!</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <form id="cancelForm" method="post" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-ban"></i> Xác nhận hủy
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function confirmCancel(orderId, orderCode) {
        document.getElementById('orderCodeText').textContent = orderCode;
        document.getElementById('cancelForm').action = '/order/cancel/' + orderId;
        $('#cancelModal').modal('show');
    }
</script>

</body>
</html>