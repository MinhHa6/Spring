<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/heads :: head"></head>
<body>

<nav th:replace="fragments/nav :: nav"></nav>

<section class="ftco-section">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-5">
                <div class="card shadow">
                    <div class="card-body p-4">
                        <!-- Icon và tiêu đề -->
                        <div class="text-center mb-4">
                            <i class="fas fa-key fa-3x text-primary mb-3"></i>
                            <h3>Đặt lại mật khẩu</h3>
                            <p class="text-muted">Nhập mật khẩu mới cho tài khoản của bạn</p>
                        </div>

                        <!-- Thông báo thành công -->
                        <div th:if="${success}" class="alert alert-success">
                            <i class="fas fa-check-circle"></i>
                            <span th:text="${success}"></span>
                            <div class="text-center mt-3">
                                <a th:href="@{/login}" class="btn btn-primary">
                                    <i class="fas fa-sign-in-alt"></i> Đăng nhập ngay
                                </a>
                            </div>
                        </div>

                        <!-- Thông báo lỗi -->
                        <div th:if="${error}" class="alert alert-danger">
                            <i class="fas fa-exclamation-circle"></i>
                            <span th:text="${error}"></span>
                            <div class="text-center mt-3">
                                <a th:href="@{/forgot-password}" class="btn btn-primary">
                                    <i class="fas fa-redo"></i> Yêu cầu link mới
                                </a>
                            </div>
                        </div>

                        <!-- Form đặt lại mật khẩu -->
                        <form
                              th:action="@{/reset-password}"
                              method="post"
                              id="resetPasswordForm">

                            <input type="hidden" name="token" th:value="${token}">

                            <div class="form-group">
                                <label for="newPassword">Mật khẩu mới <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">
                                            <i class="fas fa-lock"></i>
                                        </span>
                                    </div>
                                    <input type="password"
                                           class="form-control"
                                           id="newPassword"
                                           name="newPassword"
                                           minlength="6"
                                           placeholder="Nhập mật khẩu mới"
                                           required
                                           autofocus>
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-secondary"
                                                type="button"
                                                id="toggleNewPassword">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                                <small class="form-text text-muted">
                                    Mật khẩu phải có ít nhất 6 ký tự
                                </small>
                            </div>

                            <div class="form-group">
                                <label for="confirmPassword">Xác nhận mật khẩu <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">
                                            <i class="fas fa-lock"></i>
                                        </span>
                                    </div>
                                    <input type="password"
                                           class="form-control"
                                           id="confirmPassword"
                                           name="confirmPassword"
                                           placeholder="Nhập lại mật khẩu mới"
                                           required>
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-secondary"
                                                type="button"
                                                id="toggleConfirmPassword">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Password strength indicator -->
                            <div class="form-group">
                                <div class="progress" style="height: 5px;">
                                    <div id="passwordStrength"
                                         class="progress-bar"
                                         role="progressbar"
                                         style="width: 0%">
                                    </div>
                                </div>
                                <small id="strengthText" class="form-text"></small>
                            </div>

                            <button type="submit" class="btn btn-primary btn-block py-2">
                                <i class="fas fa-check"></i> Đặt lại mật khẩu
                            </button>
                        </form>

                        <hr class="my-4">

                        <div class="text-center">
                            <a th:href="@{/login}" class="text-primary">
                                <i class="fas fa-arrow-left"></i> Quay lại đăng nhập
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    // Toggle show/hide password
    function setupTogglePassword(buttonId, inputId) {
        document.getElementById(buttonId)?.addEventListener('click', function() {
            const input = document.getElementById(inputId);
            const icon = this.querySelector('i');

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });
    }

    setupTogglePassword('toggleNewPassword', 'newPassword');
    setupTogglePassword('toggleConfirmPassword', 'confirmPassword');

    // Password strength checker
    document.getElementById('newPassword')?.addEventListener('input', function() {
        const password = this.value;
        const strengthBar = document.getElementById('passwordStrength');
        const strengthText = document.getElementById('strengthText');

        let strength = 0;
        let text = '';
        let color = '';

        if (password.length >= 6) strength += 25;
        if (password.length >= 10) strength += 25;
        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 25;
        if (/\d/.test(password)) strength += 15;
        if (/[^a-zA-Z\d]/.test(password)) strength += 10;

        if (strength < 30) {
            text = 'Yếu';
            color = 'bg-danger';
        } else if (strength < 60) {
            text = 'Trung bình';
            color = 'bg-warning';
        } else if (strength < 80) {
            text = 'Tốt';
            color = 'bg-info';
        } else {
            text = 'Rất mạnh';
            color = 'bg-success';
        }

        strengthBar.style.width = strength + '%';
        strengthBar.className = 'progress-bar ' + color;
        strengthText.textContent = 'Độ mạnh: ' + text;
        strengthText.className = 'form-text text-' + color.replace('bg-', '');
    });

    // Validate password match
    document.getElementById('resetPasswordForm')?.addEventListener('submit', function(e) {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword !== confirmPassword) {
            e.preventDefault();
            alert('Mật khẩu xác nhận không khớp!');
            return false;
        }
    });
</script>

<div th:replace="fragments/scripts :: script"></div>

<footer th:replace="fragments/footers :: footer"></footer>

</body>
</html>
